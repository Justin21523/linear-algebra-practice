# QR 分解 (QR Decomposition)

> 把矩陣分解為正交矩陣 Q 和上三角矩陣 R——數值計算的基石

## 1. 什麼是 QR 分解？

### 定義

任何 m×n 矩陣 A（m ≥ n，行向量線性獨立）可分解為：

```
A = QR

其中：
- Q 是 m×n 矩陣，行向量標準正交（QᵀQ = I）
- R 是 n×n 上三角矩陣，對角線為正
```

### 例子

```
    [1  1]   [1/√2   1/√6 ] [√2   √2  ]
A = [1  0] = [1/√2  -1/√6 ] [ 0  √(2/3)]
    [0  1]   [ 0     2/√6 ]

    = Q × R
```

---

## 2. 為什麼 QR 分解重要？

| 應用 | 說明 |
|------|------|
| **最小平方法** | 比正規方程更穩定 |
| **QR 演算法** | 計算特徵值的基礎 |
| **解線性方程** | Ax = b → Rx = Qᵀb |
| **正交化** | 產生標準正交基底 |
| **數值穩定** | 避免計算 AᵀA |

---

## 3. QR 分解的方法

### 方法 1：Gram-Schmidt

```
對 A 的行向量做 Gram-Schmidt 正交化
→ 正交向量構成 Q
→ 投影係數構成 R
```

### 方法 2：Householder 反射

```
用 Householder 矩陣逐行消去
→ 數值更穩定
→ 工業標準
```

### 方法 3：Givens 旋轉

```
用平面旋轉逐元素消去
→ 適合稀疏矩陣
→ 可平行化
```

---

## 4. Gram-Schmidt QR 分解

### 演算法

給定 A = [a₁ | a₂ | ... | aₙ]：

```
for j = 1 to n:
    q̃ⱼ = aⱼ
    for i = 1 to j-1:
        rᵢⱼ = qᵢᵀaⱼ
        q̃ⱼ = q̃ⱼ - rᵢⱼqᵢ
    rⱼⱼ = ‖q̃ⱼ‖
    qⱼ = q̃ⱼ / rⱼⱼ
```

### R 的結構

```
    [r₁₁  r₁₂  r₁₃  ...]
R = [ 0   r₂₂  r₂₃  ...]
    [ 0    0   r₃₃  ...]
    [ ⋮    ⋮    ⋮   ⋱ ]

rᵢⱼ = qᵢᵀaⱼ（i < j）
rⱼⱼ = ‖q̃ⱼ‖
```

---

## 5. 完整範例

### 給定矩陣

```
    [1  1]
A = [1  0]
    [0  1]
```

### Step 1：處理 a₁

```
q̃₁ = a₁ = [1, 1, 0]ᵀ
r₁₁ = ‖q̃₁‖ = √2
q₁ = q̃₁ / r₁₁ = [1/√2, 1/√2, 0]ᵀ
```

### Step 2：處理 a₂

```
r₁₂ = q₁ᵀa₂ = (1/√2)×1 + (1/√2)×0 + 0×1 = 1/√2

q̃₂ = a₂ - r₁₂q₁
   = [1, 0, 1]ᵀ - (1/√2)[1/√2, 1/√2, 0]ᵀ
   = [1, 0, 1]ᵀ - [1/2, 1/2, 0]ᵀ
   = [1/2, -1/2, 1]ᵀ

r₂₂ = ‖q̃₂‖ = √(1/4 + 1/4 + 1) = √(3/2)

q₂ = q̃₂ / r₂₂ = [1/√6, -1/√6, 2/√6]ᵀ
```

### 結果

```
    [1/√2   1/√6 ]       [√2    1/√2  ]
Q = [1/√2  -1/√6 ]   R = [ 0   √(3/2) ]
    [ 0     2/√6 ]
```

### 驗證

```
QᵀQ = [1  0]
      [0  1] ✓

A = QR ✓
```

---

## 6. 用 QR 解最小平方

### 問題

```
最小化 ‖Ax - b‖²
```

### 方法

```
A = QR

‖Ax - b‖² = ‖QRx - b‖²
          = ‖Rx - Qᵀb‖²  （因為 Q 保長度）

最小化 → Rx = Qᵀb
```

### 優勢

- 避免計算 AᵀA（可能病態）
- 回代求解 Rx = Qᵀb 即可
- 數值穩定

---

## 7. Householder 反射

### 基本想法

找反射矩陣 H 把向量 x 映射到 e₁ 方向：

```
Hx = αe₁

其中 α = ±‖x‖
```

### Householder 矩陣

```
H = I - 2vvᵀ / vᵀv

v = x - αe₁
```

### 性質

```
Hᵀ = H     （對稱）
H² = I     （自逆）
HᵀH = I    （正交）
det(H) = -1（反射）
```

### 演算法

```
for k = 1 to n:
    計算 Householder 矩陣 Hₖ
    A := Hₖ × A（把第 k 行以下變成 0）

R = Hₙ...H₂H₁A
Q = H₁H₂...Hₙ
```

---

## 8. QR 分解的形式

### 瘦 QR（Thin QR）

```
A (m×n) = Q (m×n) × R (n×n)

Q 的行向量標準正交：QᵀQ = I (n×n)
但 QQᵀ ≠ I（不是方陣）
```

### 滿 QR（Full QR）

```
A (m×n) = Q (m×m) × R (m×n)

Q 是完整正交矩陣：QᵀQ = QQᵀ = I (m×m)
R 的下半部是零
```

---

## 9. 數值穩定性

### 比較

| 方法 | 穩定性 | 效率 |
|------|--------|------|
| CGS | 差 | O(2mn²) |
| MGS | 中 | O(2mn²) |
| Householder | 優 | O(2mn² - 2n³/3) |
| Givens | 優 | O(3mn² - n³) |

### 何時使用哪種？

- **一般情況**：Householder（LAPACK 預設）
- **稀疏矩陣**：Givens
- **教學理解**：Gram-Schmidt

---

## 10. 程式實作

### 本單元程式示範

| 檔案 | 內容 |
|------|------|
| `qr_decomposition_manual.py` | Gram-Schmidt QR |
| `qr_decomposition_numpy.py` | NumPy QR + 應用 |

---

## 11. 考試重點

### 常見題型

1. **手算 QR 分解**
2. **用 QR 解最小平方**
3. **驗證 QᵀQ = I**
4. **說明 Householder 原理**
5. **比較不同 QR 方法**

### 必背公式

```
A = QR

QᵀQ = I
R 是上三角

最小平方：Rx = Qᵀb

Householder：H = I - 2vvᵀ/(vᵀv)
```

### 常見錯誤

- 混淆瘦 QR 和滿 QR
- QR 分解的順序（Q 在左）
- 忘記 R 的對角線應為正

---

## 12. 與其他分解的關係

### Cholesky 分解

```
若 A 對稱正定：A = LLᵀ

與 QR 的關係：
A = QR
AᵀA = RᵀQᵀQR = RᵀR

所以 RᵀR 是 AᵀA 的 Cholesky 分解
```

### SVD

```
A = UΣVᵀ

QR 可用於計算 SVD
```

---

## 參考資料

- Strang, Chapter 4.4: Orthonormal Bases and Gram-Schmidt
- Trefethen & Bau, Numerical Linear Algebra, Chapters 7-10
- Golub & Van Loan, Matrix Computations, Chapter 5
