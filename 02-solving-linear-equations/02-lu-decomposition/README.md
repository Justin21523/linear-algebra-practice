# LU 分解 (LU Decomposition)

> 將矩陣分解為下三角與上三角的乘積——高效求解多個線性系統的關鍵

## 1. 什麼是 LU 分解？

### 定義

將方陣 A 分解為：

```
A = L · U
```

其中：
- **L** (Lower triangular)：下三角矩陣，對角線為 1
- **U** (Upper triangular)：上三角矩陣

```
[a₁₁ a₁₂ a₁₃]   [1   0   0] [u₁₁ u₁₂ u₁₃]
[a₂₁ a₂₂ a₂₃] = [l₂₁ 1   0] [0   u₂₂ u₂₃]
[a₃₁ a₃₂ a₃₃]   [l₃₁ l₃₂ 1] [0   0   u₃₃]
```

### 與高斯消去的關係

高斯消去法的本質就是：
- **U** = 消去後得到的上三角矩陣
- **L** = 儲存消去過程中的乘數

---

## 2. 為什麼 LU 分解重要？

### 效率優勢

| 場景 | 直接高斯消去 | 先 LU 分解再求解 |
|------|-------------|-----------------|
| 解 Ax = b（1 個 b）| O(n³) | O(n³) + O(n²) |
| 解 Ax = b（k 個不同的 b）| k × O(n³) | O(n³) + k × O(n²) |

當需要對**同一個 A** 但**不同的 b** 反覆求解時，LU 分解非常高效！

### 應用場景

- 模擬中的時間步進（A 固定，每步 b 不同）
- 計算反矩陣（解 n 個系統）
- 計算行列式（U 的對角線乘積）

---

## 3. LU 分解的計算

### 方法：Doolittle 演算法

逐步計算 L 和 U 的元素：

```
對於第 k 列/行：

1. 計算 U 的第 k 列（從左到右）：
   uₖⱼ = aₖⱼ - Σᵢ₌₁^(k-1) lₖᵢ · uᵢⱼ    (j ≥ k)

2. 計算 L 的第 k 行（從上到下）：
   lᵢₖ = (aᵢₖ - Σⱼ₌₁^(k-1) lᵢⱼ · uⱼₖ) / uₖₖ    (i > k)
```

### 手算範例

```
    [2   1   1]
A = [4  -6   0]
    [-2  7   2]

步驟 1：第一列/行
U 第一列：u₁₁ = 2, u₁₂ = 1, u₁₃ = 1
L 第一行：l₂₁ = 4/2 = 2, l₃₁ = -2/2 = -1

步驟 2：第二列/行
u₂₂ = a₂₂ - l₂₁·u₁₂ = -6 - 2×1 = -8
u₂₃ = a₂₃ - l₂₁·u₁₃ = 0 - 2×1 = -2
l₃₂ = (a₃₂ - l₃₁·u₁₂) / u₂₂ = (7 - (-1)×1) / (-8) = -1

步驟 3：第三列
u₃₃ = a₃₃ - l₃₁·u₁₃ - l₃₂·u₂₃ = 2 - (-1)×1 - (-1)×(-2) = 1

結果：
    [1   0   0]       [2   1   1]
L = [2   1   0]   U = [0  -8  -2]
    [-1 -1   1]       [0   0   1]
```

---

## 4. 用 LU 分解求解 Ax = b

### 兩步驟求解

將 Ax = b 改寫為 L(Ux) = b：

```
步驟 1：解 Ly = b（前進代入，Forward substitution）
步驟 2：解 Ux = y（回代，Back substitution）
```

### 範例

```
A = LU, b = [5, -2, 9]ᵀ

步驟 1：解 Ly = b
[1   0   0] [y₁]   [5]
[2   1   0] [y₂] = [-2]
[-1 -1   1] [y₃]   [9]

y₁ = 5
y₂ = -2 - 2×5 = -12
y₃ = 9 - (-1)×5 - (-1)×(-12) = 2

y = [5, -12, 2]ᵀ

步驟 2：解 Ux = y
[2   1   1] [x₁]   [5]
[0  -8  -2] [x₂] = [-12]
[0   0   1] [x₃]   [2]

x₃ = 2
x₂ = (-12 - (-2)×2) / (-8) = 1
x₁ = (5 - 1×1 - 1×2) / 2 = 1

x = [1, 1, 2]ᵀ
```

---

## 5. 帶選主元的 LU 分解 (LU with Pivoting)

### PLU 分解

當需要換列時，LU 分解變成：

```
PA = LU
```

其中 **P** 是**置換矩陣**，記錄所有的列交換。

### 為什麼需要？

1. 主元為零時必須換列
2. 主元太小時換列可提高數值穩定性

### 求解 Ax = b

```
PA = LU
PAx = Pb
LUx = Pb

步驟 1：解 Ly = Pb（先對 b 做同樣的置換）
步驟 2：解 Ux = y
```

---

## 6. LU 分解的性質

### 存在性

- **定理**：若 A 的所有前導主子陣（leading principal minors）都非零，則 A 有唯一的 LU 分解
- 若 A 可逆，則 PLU 分解一定存在

### 唯一性

- 若限制 L 的對角線為 1（Doolittle），則分解唯一
- 若限制 U 的對角線為 1（Crout），則分解也唯一

### 行列式

```
det(A) = det(L) × det(U) = 1 × (u₁₁ × u₂₂ × ... × uₙₙ)

det(A) = U 的對角線元素乘積（注意 P 的符號）
```

---

## 7. Cholesky 分解（對稱正定矩陣）

### 定義

若 A 是**對稱正定矩陣**，則存在**唯一**的下三角矩陣 L 使得：

```
A = LLᵀ
```

### 優勢

- 只需要一半的儲存空間
- 計算量是一般 LU 分解的一半
- 保證數值穩定（不需要選主元）

### 應用

- 共變異數矩陣的處理
- 最小平方法的正規方程

---

## 8. 程式實作重點

### 本單元程式示範

| 檔案 | 內容 |
|------|------|
| `lu_decomposition_manual.py` | 手刻 LU 分解 + 求解 |
| `lu_decomposition_numpy.py` | NumPy/SciPy LU 分解 |

### 實作功能

1. Doolittle LU 分解
2. 前進代入與回代
3. PLU 分解（帶選主元）
4. 用 LU 分解計算行列式

---

## 9. 考試重點

### 常見題型

1. **手算 LU 分解**：給定 3×3 矩陣求 L 和 U
2. **用 LU 求解**：給定 L、U、b，求 x
3. **計算行列式**：利用 U 的對角線
4. **說明效率**：為什麼 LU 分解對多個 b 更高效

### 關鍵公式

```
A = LU
det(A) = u₁₁ × u₂₂ × ... × uₙₙ
Ax = b → Ly = b → Ux = y
```

### 常見錯誤

- L 和 U 的元素計算順序搞錯
- 忘記 L 的對角線是 1
- 前進代入和回代的方向搞混

---

## 參考資料

- Strang, Chapter 2.6: LU Factorization
- MIT 18.06 Lecture 6
- Numerical Linear Algebra (Trefethen & Bau), Chapter 20-21
